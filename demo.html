<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âè£ÁÆóÈõ∑ÁîµÊ∏∏Êàè</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        #gameContainer {
            position: relative;
        }
        canvas {
            border: 2px solid #333;
            display: block;
        }
        #mathModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff6600;
            padding: 30px;
            border-radius: 10px;
            display: none;
            z-index: 100;
            min-width: 300px;
            text-align: center;
        }
        #mathModal h2 {
            color: #ff6600;
            margin-bottom: 20px;
            font-size: 24px;
        }
        #mathQuestion {
            color: #fff;
            font-size: 28px;
            margin-bottom: 20px;
        }
        #mathAnswer {
            padding: 10px;
            font-size: 20px;
            width: 100px;
            text-align: center;
            background: #222;
            color: #fff;
            border: 2px solid #ff6600;
            border-radius: 5px;
        }
        #submitAnswer {
            padding: 10px 20px;
            font-size: 18px;
            background: #ff6600;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        #submitAnswer:hover {
            background: #ff8800;
        }
        #mathModal p {
            color: #aaa;
            font-size: 14px;
            margin-top: 15px;
            margin-bottom: 0;
        }
        #gameInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 18px;
            z-index: 10;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }
        #powerupInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #00ff00;
            font-size: 16px;
            z-index: 10;
            text-align: right;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }
        #pauseOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 90;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #pauseOverlay h2 {
            color: #00ff00;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        #pauseOverlay p {
            color: #fff;
            font-size: 20px;
        }
        .damage-hint {
            color: #ff6600;
            font-size: 14px;
            margin-top: 10px;
        }
        #gameOverOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #gameOverOverlay h1 {
            color: #ff4444;
            font-size: 64px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff4444;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 20px #ff4444; }
            to { text-shadow: 0 0 30px #ff4444, 0 0 40px #ff6666; }
        }
        #gameOverOverlay .final-score {
            color: #00ff00;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        #gameOverOverlay .game-stats {
            color: #fff;
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.5;
        }
        #gameOverOverlay .game-stats div {
            margin: 5px 0;
        }
        #restartButton {
            padding: 15px 30px;
            font-size: 24px;
            background: linear-gradient(45deg, #ff6600, #ff8800);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
            transition: all 0.3s ease;
        }
        #restartButton:hover {
            background: linear-gradient(45deg, #ff8800, #ffaa00);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }
        #backToMenuButton {
            padding: 10px 20px;
            font-size: 18px;
            background: transparent;
            color: #888;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        #backToMenuButton:hover {
            color: #fff;
            border-color: #777;
        }
        .achievement {
            color: #ffd700;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px #ffd700;
        }
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            display: flex;
            z-index: 300;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: backgroundFlow 10s ease-in-out infinite alternate;
        }
        @keyframes backgroundFlow {
            0% { background: linear-gradient(135deg, #000428 0%, #004e92 100%); }
            50% { background: linear-gradient(135deg, #004e92 0%, #009ffd 100%); }
            100% { background: linear-gradient(135deg, #000428 0%, #004e92 100%); }
        }
        #startScreen h1 {
            color: #00ff00;
            font-size: 72px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
            animation: titleGlow 3s ease-in-out infinite alternate;
            font-family: 'Arial Black', Arial, sans-serif;
            letter-spacing: 3px;
        }
        @keyframes titleGlow {
            from { 
                text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px #00ff00, 0 0 80px #00ff00, 0 0 120px #00ff00;
                transform: scale(1.05);
            }
        }
        #startScreen .subtitle {
            color: #fff;
            font-size: 24px;
            margin-bottom: 40px;
            text-align: center;
            opacity: 0.9;
        }
        #startScreen .game-features {
            color: #aaa;
            font-size: 16px;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.6;
        }
        #startScreen .game-features div {
            margin: 8px 0;
        }
        .start-button {
            padding: 20px 40px;
            font-size: 28px;
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 15px;
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .start-button:hover {
            background: linear-gradient(45deg, #00cc00, #00aa00);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.4);
        }
        .difficulty-selector {
            margin: 30px 0;
            text-align: center;
        }
        .difficulty-selector h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .difficulty-button {
            padding: 10px 20px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .difficulty-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #777;
        }
        .difficulty-button.selected {
            background: linear-gradient(45deg, #ff6600, #ff8800);
            border-color: #ff6600;
            color: #fff;
        }
        .controls-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #888;
            font-size: 14px;
            text-align: center;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="startScreen">
            <h1>Âè£ÁÆóÈõ∑Áîµ</h1>
            <div class="subtitle">ËæπÁé©ËæπÂ≠¶ÔºåÊèêÂçáÊï∞Â≠¶ÊäÄËÉΩÁöÑÂ∞ÑÂáªÊ∏∏Êàè</div>
            <div class="game-features">
                <div>üöÄ ÊøÄÁÉàÁöÑÂ∞ÑÂáªÊàòÊñó‰ΩìÈ™å</div>
                <div>üßÆ ÈÄöËøáËß£È¢òËé∑ÂæóÂº∫ÂäõÈÅìÂÖ∑</div>
                <div>‚ö° Â§öÁßçÊ≠¶Âô®ÂíåÊäÄËÉΩÁ≥ªÁªü</div>
                <div>üéØ ‰∏ªÂä®ÈÄâÊã©ÂÅöÈ¢òÊó∂Êú∫</div>
            </div>
            <div class="difficulty-selector">
                <h3>ÈÄâÊã©Êï∞Â≠¶ÈöæÂ∫¶</h3>
                <button class="difficulty-button selected" data-grade="1">G1 - 10‰ª•ÂÜÖÂä†ÂáèÊ≥ï</button>
                <button class="difficulty-button" data-grade="2">G2 - 20‰ª•ÂÜÖÂä†ÂáèÊ≥ï</button>
                <button class="difficulty-button" data-grade="3">G3 - ‰πòÊ≥ïËøêÁÆó</button>
            </div>
            <button class="start-button" id="startGameButton">ÂºÄÂßãÊ∏∏Êàè</button>
            <div class="controls-info">
                <div><strong>Êìç‰ΩúËØ¥ÊòéÔºö</strong></div>
                <div>ÊñπÂêëÈîÆÁßªÂä® | Ëá™Âä®Â∞ÑÂáª | PÈîÆÊöÇÂÅú | ÂêÉÈÅìÂÖ∑ÂÅöÈ¢òËé∑ÂæóÂ•ñÂä±</div>
            </div>
        </div>
        <canvas id="gameCanvas" width="600" height="800"></canvas>
        <div id="gameInfo">
            <div>ÁîüÂëΩÂÄº: <span id="lives">3</span></div>
            <div>ÂàÜÊï∞: <span id="score">0</span></div>
            <div>Êä§Áõæ: <span id="shield">0</span></div>
            <div>ÂØºÂºπ: <span id="missiles">0</span></div>
            <div style="margin-top: 10px; font-size: 14px; color: #888;">Êåâ P ÊöÇÂÅú</div>
        </div>
        <div id="powerupInfo">
            <div>Ê≠¶Âô®Á≠âÁ∫ß: <span id="weaponLevel">1</span></div>
            <div>ÈöæÂ∫¶: G<span id="gradeLevel">1</span></div>
        </div>
        <div id="pauseOverlay">
            <h2>Ê∏∏ÊàèÊöÇÂÅú</h2>
            <p>Êåâ P ÈîÆÁªßÁª≠Ê∏∏Êàè</p>
        </div>
        <div id="mathModal">
            <h2>ÈÅìÂÖ∑ÊøÄÊ¥ªÔºÅ</h2>
            <div class="damage-hint">Ëß£Á≠îÊï∞Â≠¶È¢òËé∑ÂæóÈÅìÂÖ∑Â•ñÂä±</div>
            <div id="mathQuestion"></div>
            <input type="number" id="mathAnswer" autofocus>
            <button id="submitAnswer">Á°ÆÂÆö</button>
            <p style="color: #888; font-size: 14px; margin-top: 10px;">Á≠îÂØπËé∑ÂæóÂº∫ÂåñÂ•ñÂä±ÔºåÁ≠îÈîôËé∑ÂæóÂü∫Á°ÄÂ•ñÂä±</p>
        </div>
        <div id="gameOverOverlay">
            <h1>GAME OVER</h1>
            <div class="final-score">ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></div>
            <div class="game-stats">
                <div>ÂáªË¥•ÊïåÊú∫: <span id="finalEnemies">0</span> Êû∂</div>
                <div>Â≠òÊ¥ªÊó∂Èó¥: <span id="survivalTime">0</span> Áßí</div>
                <div>ÊúÄÈ´òÊ≠¶Âô®Á≠âÁ∫ß: <span id="maxWeaponLevel">1</span></div>
                <div>Êï∞Â≠¶È¢òÈöæÂ∫¶: G<span id="finalGrade">1</span></div>
                <div id="achievementText" class="achievement" style="display: none;"></div>
            </div>
            <button id="restartButton">ÈáçÊñ∞ÂºÄÂßã</button>
            <button id="backToMenuButton">ËøîÂõû‰∏ªËèúÂçï</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        const GAME_STATES = {
            START: 'start',
            PLAYING: 'playing',
            GAME_OVER: 'gameOver'
        };

        const game = {
            state: GAME_STATES.START,
            paused: false,
            manualPaused: false,  // ÊâãÂä®ÊöÇÂÅúÁä∂ÊÄÅ
            score: 0,
            lives: 3,
            shield: 0,
            weaponLevel: 1,
            gradeLevel: 1,
            enemiesDefeated: 0,
            missiles: 0,  // ÂØºÂºπÊï∞Èáè
            invulnerable: 0,  // Êó†ÊïåÊó∂Èó¥ÔºàÂ∏ßÊï∞Ôºâ
            startTime: Date.now(),
            maxWeaponLevel: 1
        };

        // Áé©ÂÆ∂È£ûÊú∫
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 40,
            height: 40,
            speed: 5,
            bullets: []
        };

        // ÊïåÊú∫Êï∞ÁªÑ
        const enemies = [];
        const enemyBullets = [];
        const explosions = [];
        const missiles = [];  // ÂØºÂºπÊï∞ÁªÑ
        const powerups = [];  // ÈÅìÂÖ∑Êï∞ÁªÑ

        // ÈîÆÁõòÁä∂ÊÄÅ
        const keys = {};

        // Êï∞Â≠¶È¢òÁ≥ªÁªü
        class MathQuestion {
            constructor(grade) {
                this.grade = grade;
                this.generateQuestion();
            }

            generateQuestion() {
                switch(this.grade) {
                    case 1: // G1: 10‰ª•ÂÜÖÂä†ÂáèÊ≥ï
                        const a = Math.floor(Math.random() * 10) + 1;
                        const b = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) {
                            this.question = `${a} + ${b} = ?`;
                            this.answer = a + b;
                        } else {
                            const max = Math.max(a, b);
                            const min = Math.min(a, b);
                            this.question = `${max} - ${min} = ?`;
                            this.answer = max - min;
                        }
                        break;
                    case 2: // G2: 20‰ª•ÂÜÖÂä†ÂáèÊ≥ï
                        const c = Math.floor(Math.random() * 20) + 1;
                        const d = Math.floor(Math.random() * 20) + 1;
                        if (Math.random() < 0.5) {
                            this.question = `${c} + ${d} = ?`;
                            this.answer = c + d;
                        } else {
                            const max2 = Math.max(c, d);
                            const min2 = Math.min(c, d);
                            this.question = `${max2} - ${min2} = ?`;
                            this.answer = max2 - min2;
                        }
                        break;
                    case 3: // G3: ‰πòÊ≥ï
                        const e = Math.floor(Math.random() * 10) + 1;
                        const f = Math.floor(Math.random() * 10) + 1;
                        this.question = `${e} √ó ${f} = ?`;
                        this.answer = e * f;
                        break;
                    default:
                        this.generateQuestion.call({grade: 1});
                }
            }
        }

        // ÈÅìÂÖ∑Á±ªÂûã
        const POWERUP_TYPES = {
            WEAPON: { color: '#ffff00', name: 'Ê≠¶Âô®ÂçáÁ∫ß', icon: '‚ö°' },
            SHIELD: { color: '#00ffff', name: 'Êä§Áõæ', icon: 'üõ°Ô∏è' },
            LIFE: { color: '#ff00ff', name: 'ÁîüÂëΩÂÄº', icon: '‚ù§Ô∏è' },
            BOMB: { color: '#ff4444', name: 'Ê∏ÖÂ±èÁÇ∏Âºπ', icon: 'üí•' },
            MISSILE: { color: '#00ff00', name: 'ËøΩË∏™ÂØºÂºπ', icon: 'üöÄ' },
            SCORE: { color: '#ffd700', name: 'ÂàÜÊï∞Â•ñÂä±', icon: '‚≠ê' }
        };

        // ÂàõÂª∫ÊïåÊú∫
        function createEnemy() {
            enemies.push({
                x: Math.random() * (canvas.width - 40),
                y: -40,
                width: 40,
                height: 40,
                speed: 2 + Math.random() * 2,
                hp: 1,
                shootTimer: 0
            });
        }

        // ÂàõÂª∫Â≠êÂºπ
        function createBullet(x, y, angle = 0, isPlayer = true) {
            const bullet = {
                x: x,
                y: y,
                width: 4,
                height: 10,
                speed: isPlayer ? 10 : 5,
                angle: angle,
                isPlayer: isPlayer
            };
            
            if (isPlayer) {
                player.bullets.push(bullet);
            } else {
                enemyBullets.push(bullet);
            }
        }

        // ÂàõÂª∫ÈÅìÂÖ∑
        function createPowerup(x, y, type) {
            const powerupType = POWERUP_TYPES[type];
            powerups.push({
                x: x,
                y: y,
                width: 35,
                height: 35,
                type: type,
                speed: 1.5,
                color: powerupType.color,
                name: powerupType.name,
                icon: powerupType.icon,
                bobOffset: Math.random() * Math.PI * 2, // ÊµÆÂä®Âä®ÁîªÂÅèÁßª
                glowRadius: 20
            });
        }

        // ÈöèÊú∫ÊéâËêΩÈÅìÂÖ∑
        function dropRandomPowerup(x, y) {
            // 30% Ê¶ÇÁéáÊéâËêΩÈÅìÂÖ∑
            if (Math.random() < 0.3) {
                const types = Object.keys(POWERUP_TYPES);
                const randomType = types[Math.floor(Math.random() * types.length)];
                createPowerup(x, y, randomType);
            }
        }

        // ÂàõÂª∫ÂØºÂºπ
        function createMissile(x, y) {
            if (enemies.length === 0) return;
            
            // ÊâæÂà∞ÊúÄËøëÁöÑÊïå‰∫∫
            let nearestEnemy = enemies[0];
            let minDistance = Infinity;
            
            enemies.forEach(enemy => {
                const distance = Math.sqrt(Math.pow(enemy.x - x, 2) + Math.pow(enemy.y - y, 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestEnemy = enemy;
                }
            });
            
            missiles.push({
                x: x,
                y: y,
                width: 8,
                height: 16,
                speed: 8,
                target: nearestEnemy,
                trail: []  // ÂØºÂºπÂ∞æËøπ
            });
        }

        // ÂàáÊç¢ÊöÇÂÅúÁä∂ÊÄÅ
        function togglePause() {
            if (!game.paused) {
                // ÊöÇÂÅúÊ∏∏Êàè
                game.paused = true;
                game.manualPaused = true;
                document.getElementById('pauseOverlay').style.display = 'flex';
            } else if (game.manualPaused && !document.getElementById('mathModal').style.display.includes('block')) {
                // ÁªßÁª≠Ê∏∏ÊàèÔºà‰ªÖÂΩì‰∏çÊòØÊï∞Â≠¶È¢òÊöÇÂÅúÊó∂Ôºâ
                game.paused = false;
                game.manualPaused = false;
                document.getElementById('pauseOverlay').style.display = 'none';
            }
        }

        // ÂàõÂª∫ÁàÜÁÇ∏ÊïàÊûú
        function createExplosion(x, y) {
            explosions.push({
                x: x,
                y: y,
                radius: 5,
                maxRadius: 30,
                alpha: 1
            });
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÁîªÈù¢
        function showGameOver() {
            game.state = GAME_STATES.GAME_OVER;
            game.paused = true;
            
            // ËÆ°ÁÆóÁîüÂ≠òÊó∂Èó¥
            const survivalTime = Math.floor((Date.now() - game.startTime) / 1000);
            
            // Ê£ÄÊµãÊàêÂ∞±
            let achievement = '';
            if (game.score >= 5000) achievement = 'üèÜ ‰º†Â•áÈ£ûË°åÂëòÔºÅ';
            else if (game.score >= 2000) achievement = '‚≠ê ÁéãÁâåÈ£ûË°åÂëòÔºÅ';
            else if (game.score >= 1000) achievement = 'üéñÔ∏è Á≤æËã±È£ûË°åÂëòÔºÅ';
            else if (game.enemiesDefeated >= 50) achievement = 'üí• ÊïåÊú∫ÊùÄÊâãÔºÅ';
            else if (survivalTime >= 300) achievement = '‚è∞ Èïø‰πÖÁîüÂ≠òËÄÖÔºÅ';
            else if (game.maxWeaponLevel >= 3) achievement = 'üî´ Ê≠¶Âô®Â§ßÂ∏àÔºÅ';
            else if (game.gradeLevel >= 3) achievement = 'üßÆ Êï∞Â≠¶Â§©ÊâçÔºÅ';
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÁªìÊùüÁîªÈù¢ÁöÑÊï∞ÊçÆ
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('finalEnemies').textContent = game.enemiesDefeated;
            document.getElementById('survivalTime').textContent = survivalTime;
            document.getElementById('maxWeaponLevel').textContent = game.maxWeaponLevel;
            document.getElementById('finalGrade').textContent = game.gradeLevel;
            
            // ÊòæÁ§∫ÊàêÂ∞±
            if (achievement) {
                document.getElementById('achievementText').textContent = achievement;
                document.getElementById('achievementText').style.display = 'block';
            } else {
                document.getElementById('achievementText').style.display = 'none';
            }
            
            // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÁîªÈù¢
            document.getElementById('gameOverOverlay').style.display = 'flex';
        }

        // ÂºÄÂßãÊ∏∏Êàè
        function startGame() {
            game.state = GAME_STATES.PLAYING;
            game.paused = false;
            game.manualPaused = false;
            game.score = 0;
            game.lives = 3;
            game.shield = 0;
            game.weaponLevel = 1;
            game.enemiesDefeated = 0;
            game.missiles = 0;
            game.invulnerable = 0;
            game.startTime = Date.now();
            game.maxWeaponLevel = 1;
            
            // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
            player.x = canvas.width / 2;
            player.y = canvas.height - 100;
            
            // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÁªÑ
            player.bullets.length = 0;
            enemies.length = 0;
            enemyBullets.length = 0;
            explosions.length = 0;
            missiles.length = 0;
            powerups.length = 0;
            
            // ÈöêËóèÂêØÂä®È°µÈù¢ÔºåÊòæÁ§∫Ê∏∏ÊàèUI
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'block';
            document.getElementById('powerupInfo').style.display = 'block';
        }

        // ËøîÂõûÂêØÂä®È°µÈù¢
        function returnToStart() {
            game.state = GAME_STATES.START;
            game.paused = false;
            game.manualPaused = false;
            
            // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÁªÑ
            player.bullets.length = 0;
            enemies.length = 0;
            enemyBullets.length = 0;
            explosions.length = 0;
            missiles.length = 0;
            powerups.length = 0;
            
            // ÊòæÁ§∫ÂêØÂä®È°µÈù¢ÔºåÈöêËóèÊ∏∏ÊàèUI
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('powerupInfo').style.display = 'none';
        }

        // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
        function restartGame() {
            startGame();
        }

        // Áé©ÂÆ∂Âèó‰º§Â§ÑÁêÜ
        function playerTakeDamage() {
            if (game.invulnerable > 0) return; // Êó†ÊïåÁä∂ÊÄÅ‰∏≠‰∏çÂèó‰º§
            
            if (game.shield > 0) {
                game.shield--;
                game.invulnerable = 60; // 1ÁßíÊó†ÊïåÊó∂Èó¥
            } else {
                game.lives--;
                game.invulnerable = 120; // 2ÁßíÊó†ÊïåÊó∂Èó¥
                if (game.lives <= 0) {
                    showGameOver();
                    return;
                }
            }
        }

        // ÊòæÁ§∫Êï∞Â≠¶È¢ò
        function showMathQuestion() {
            game.paused = true;
            const question = new MathQuestion(game.gradeLevel);
            
            document.getElementById('mathQuestion').textContent = question.question;
            document.getElementById('mathAnswer').value = '';
            document.getElementById('mathModal').style.display = 'block';
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('mathAnswer').focus();
            }, 100);
            
            // Â§ÑÁêÜÁ≠îÊ°àÊèê‰∫§
            const submitHandler = () => {
                const userAnswer = parseInt(document.getElementById('mathAnswer').value);
                let rewardMessage = '';
                
                if (userAnswer === question.answer) {
                    // Á≠îÂØπ‰∫ÜÔºåËé∑ÂæóÊïëÊè¥Â•ñÂä±
                    const types = Object.keys(POWERUP_TYPES);
                    const randomType = types[Math.floor(Math.random() * types.length)];
                    
                    // Áõ¥Êé•Â∫îÁî®ÈÅìÂÖ∑ÊïàÊûú
                    switch(randomType) {
                        case 'WEAPON':
                            if (game.weaponLevel < 3) {
                                game.weaponLevel++;
                                game.maxWeaponLevel = Math.max(game.maxWeaponLevel, game.weaponLevel);
                                rewardMessage = 'Ê≠¶Âô®ÂçáÁ∫ßÔºÅÈ£ûÊú∫‰øÆÂ§çÂÆåÊàêÔºÅ';
                            } else {
                                rewardMessage = 'Ê≠¶Âô®Â∑≤Êª°Á∫ßÔºÅËé∑Âæó200ÂàÜ‰øÆÂ§çÂ•ñÂä±ÔºÅ';
                                game.score += 200;
                            }
                            break;
                        case 'SHIELD':
                            game.shield = Math.min(game.shield + 15, 25);
                            rewardMessage = 'Êä§ÁõæÂº∫ÂåñÔºÅËé∑ÂæóÊä§Áõæ+15ÔºÅ';
                            break;
                        case 'LIFE':
                            game.lives = Math.min(game.lives + 1, 5);
                            rewardMessage = 'ÁîüÂëΩÂÄºÊÅ¢Â§çÔºÅ+1ÁîüÂëΩÔºÅ';
                            break;
                        case 'BOMB':
                            // Ê∏ÖÂ±èÁÇ∏ÂºπÊïàÊûú
                            enemies.forEach(enemy => {
                                createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                                game.score += 10;
                            });
                            enemies.length = 0;
                            enemyBullets.length = 0;
                            rewardMessage = 'Á¥ßÊÄ•Ê∏ÖÂ±èÔºÅÊâÄÊúâÊïåÊú∫Ë¢´Ê∂àÁÅ≠ÔºÅ';
                            break;
                        case 'MISSILE':
                            game.missiles = Math.min(game.missiles + 50, 100);
                            rewardMessage = 'ÂØºÂºπË°•ÁªôÔºÅËé∑ÂæóËøΩË∏™ÂØºÂºπ+50ÔºÅ';
                            break;
                    }
                    
                    game.score += 100; // ÊïëÊè¥ÊàêÂäüÈ¢ùÂ§ñÂä†ÂàÜ
                    game.invulnerable = 180; // 3ÁßíÊó†ÊïåÊó∂Èó¥
                } else {
                    // Á≠îÈîô‰∫ÜÔºåÁªô‰∫àÂÆâÊÖ∞Â•ñÂä±
                    rewardMessage = '‰øÆÂ§çÊú™ÂÆåÊàêÔºå‰ΩÜËé∑Âæó1Áßí‰øùÊä§Êó∂Èó¥';
                    game.invulnerable = 60; // 1Áßí‰øùÊä§Êó∂Èó¥
                }
                
                // ÂÖàÂÖ≥Èó≠ÂØπËØùÊ°Ü
                document.getElementById('mathModal').style.display = 'none';
                game.paused = false;
                game.manualPaused = false;
                
                // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.getElementById('submitAnswer').removeEventListener('click', submitHandler);
                document.getElementById('mathAnswer').removeEventListener('keypress', enterHandler);
                document.getElementById('mathAnswer').removeEventListener('input', inputHandler);
                
                // Âª∂ËøüÊòæÁ§∫Â•ñÂä±‰ø°ÊÅØ
                if (rewardMessage) {
                    setTimeout(() => {
                        const rewardDiv = document.createElement('div');
                        const isSuccess = userAnswer === question.answer;
                        const borderColor = isSuccess ? '#00ff00' : '#ff6600';
                        const textColor = isSuccess ? '#00ff00' : '#ff6600';
                        
                        rewardDiv.style.cssText = `position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: ${textColor}; font-size: 24px; font-weight: bold; z-index: 200; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 10px; border: 2px solid ${borderColor};`;
                        rewardDiv.textContent = rewardMessage;
                        document.getElementById('gameContainer').appendChild(rewardDiv);
                        
                        // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                        setTimeout(() => {
                            rewardDiv.style.transition = 'opacity 0.5s';
                            rewardDiv.style.opacity = '0';
                            setTimeout(() => rewardDiv.remove(), 500);
                        }, 2000);
                    }, 100);
                }
            };
            
            const enterHandler = (e) => {
                if (e.key === 'Enter' && document.getElementById('mathAnswer').value !== '') {
                    submitHandler();
                }
            };
            
            // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñÔºåËá™Âä®Êèê‰∫§
            const inputHandler = (e) => {
                const userAnswer = parseInt(e.target.value);
                // Ê£ÄÊü•Á≠îÊ°àÊòØÂê¶ÂèØËÉΩÊ≠£Á°ÆÔºàÈÅøÂÖçËæìÂÖ•ËøáÁ®ã‰∏≠ËØØÂà§Ôºâ
                if (!isNaN(userAnswer) && e.target.value.length >= question.answer.toString().length) {
                    // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÔºåËÆ©Áî®Êà∑ÁúãÊ∏ÖËá™Â∑±ËæìÂÖ•ÁöÑÂÜÖÂÆπ
                    setTimeout(() => {
                        if (document.getElementById('mathAnswer').value === e.target.value) {
                            submitHandler();
                        }
                    }, 300);
                }
            };
            
            document.getElementById('submitAnswer').addEventListener('click', submitHandler);
            document.getElementById('mathAnswer').addEventListener('keypress', enterHandler);
            document.getElementById('mathAnswer').addEventListener('input', inputHandler);
        }

        // Êõ¥Êñ∞Ê∏∏Êàè
        function update() {
            if (game.state !== GAME_STATES.PLAYING || game.paused) return;
            
            // Êõ¥Êñ∞Êó†ÊïåÊó∂Èó¥
            if (game.invulnerable > 0) {
                game.invulnerable--;
            }
            
            // Êõ¥Êñ∞Áé©ÂÆ∂‰ΩçÁΩÆ
            if (keys['ArrowLeft'] && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            if (keys['ArrowUp'] && player.y > 0) {
                player.y -= player.speed;
            }
            if (keys['ArrowDown'] && player.y < canvas.height - player.height) {
                player.y += player.speed;
            }
            
            // Ëá™Âä®ÂèëÂ∞ÑÂ≠êÂºπ
            if (!player.lastShot || Date.now() - player.lastShot > 200) {
                if (game.weaponLevel === 1) {
                    createBullet(player.x + player.width / 2, player.y);
                } else if (game.weaponLevel === 2) {
                    createBullet(player.x + 10, player.y);
                    createBullet(player.x + player.width - 10, player.y);
                } else if (game.weaponLevel >= 3) {
                    createBullet(player.x + player.width / 2, player.y);
                    createBullet(player.x + 5, player.y, -0.2);
                    createBullet(player.x + player.width - 5, player.y, 0.2);
                }
                player.lastShot = Date.now();
            }
            
            // Ëá™Âä®ÂèëÂ∞ÑÂØºÂºπ
            if (game.missiles > 0 && (!player.lastMissile || Date.now() - player.lastMissile > 1000)) {
                createMissile(player.x + player.width / 2, player.y);
                game.missiles--;
                player.lastMissile = Date.now();
            }
            
            // Êõ¥Êñ∞Áé©ÂÆ∂Â≠êÂºπ
            player.bullets = player.bullets.filter(bullet => {
                bullet.y -= bullet.speed;
                bullet.x += Math.sin(bullet.angle) * bullet.speed;
                return bullet.y > -10 && bullet.x > -10 && bullet.x < canvas.width + 10;
            });
            
            // Êõ¥Êñ∞ÊïåÊú∫
            enemies.forEach((enemy, enemyIndex) => {
                enemy.y += enemy.speed;
                
                // ÊïåÊú∫Â∞ÑÂáª
                enemy.shootTimer++;
                if (enemy.shootTimer > 60) {
                    createBullet(enemy.x + enemy.width / 2, enemy.y + enemy.height, 0, false);
                    enemy.shootTimer = 0;
                }
                
                // Ê£ÄÊü•‰∏éÁé©ÂÆ∂Â≠êÂºπÁöÑÁ¢∞Êíû
                player.bullets.forEach((bullet, bulletIndex) => {
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        enemy.hp--;
                        player.bullets.splice(bulletIndex, 1);
                        
                        if (enemy.hp <= 0) {
                            createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                            
                            // ÊéâËêΩÈÅìÂÖ∑
                            dropRandomPowerup(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                            
                            enemies.splice(enemyIndex, 1);
                            game.score += 10;
                            game.enemiesDefeated++;
                        }
                    }
                });
            });
            
            // ÁßªÈô§Á¶ªÂºÄÂ±èÂπïÁöÑÊïåÊú∫
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (enemies[i].y > canvas.height) {
                    enemies.splice(i, 1);
                }
            }
            
            // Êõ¥Êñ∞ÊïåÊú∫Â≠êÂºπ
            enemyBullets.forEach((bullet, index) => {
                bullet.y += bullet.speed;
                
                // Ê£ÄÊü•‰∏éÁé©ÂÆ∂ÁöÑÁ¢∞Êíû
                if (bullet.x < player.x + player.width &&
                    bullet.x + bullet.width > player.x &&
                    bullet.y < player.y + player.height &&
                    bullet.y + bullet.height > player.y) {
                    
                    enemyBullets.splice(index, 1);
                    playerTakeDamage(); // Ë∞ÉÁî®Âèó‰º§Â§ÑÁêÜÂáΩÊï∞
                }
            });
            
            // ÁßªÈô§Á¶ªÂºÄÂ±èÂπïÁöÑÊïåÊú∫Â≠êÂºπ
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                if (enemyBullets[i].y > canvas.height) {
                    enemyBullets.splice(i, 1);
                }
            }
            
            // Êõ¥Êñ∞ÂØºÂºπ
            missiles.forEach((missile, missileIndex) => {
                // Ê∑ªÂä†Â∞æËøπ
                missile.trail.push({ x: missile.x, y: missile.y, alpha: 1 });
                if (missile.trail.length > 10) {
                    missile.trail.shift();
                }
                
                // Êõ¥Êñ∞Â∞æËøπÈÄèÊòéÂ∫¶
                missile.trail.forEach((point, i) => {
                    point.alpha = (i + 1) / missile.trail.length * 0.5;
                });
                
                // Â¶ÇÊûúÁõÆÊ†áËøòÂ≠òÂú®ÔºåËøΩË∏™ÁõÆÊ†á
                if (missile.target && enemies.includes(missile.target)) {
                    const dx = missile.target.x + missile.target.width / 2 - missile.x;
                    const dy = missile.target.y + missile.target.height / 2 - missile.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        missile.x += (dx / distance) * missile.speed;
                        missile.y += (dy / distance) * missile.speed;
                    }
                    
                    // Ê£ÄÊü•Á¢∞Êíû
                    if (distance < 20) {
                        createExplosion(missile.target.x + missile.target.width / 2, 
                                      missile.target.y + missile.target.height / 2);
                        
                        // ÊéâËêΩÈÅìÂÖ∑
                        dropRandomPowerup(missile.target.x + missile.target.width / 2, 
                                        missile.target.y + missile.target.height / 2);
                        
                        const enemyIndex = enemies.indexOf(missile.target);
                        if (enemyIndex > -1) {
                            enemies.splice(enemyIndex, 1);
                            game.score += 15;  // ÂØºÂºπÂáª‰∏≠È¢ùÂ§ñÂä†ÂàÜ
                        }
                        missiles.splice(missileIndex, 1);
                    }
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÁõÆÊ†áÔºåÂêë‰∏äÈ£ûË°å
                    missile.y -= missile.speed;
                    
                    // Á¶ªÂºÄÂ±èÂπïÂêéÁßªÈô§
                    if (missile.y < -20) {
                        missiles.splice(missileIndex, 1);
                    }
                }
            });
            
            // Êõ¥Êñ∞ÁàÜÁÇ∏ÊïàÊûú
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.radius += 2;
                explosion.alpha -= 0.05;
                
                if (explosion.alpha <= 0) {
                    explosions.splice(i, 1);
                }
            }
            
            // ÁîüÊàêÊñ∞ÊïåÊú∫
            if (Math.random() < 0.02) {
                createEnemy();
            }
            
            // Êõ¥Êñ∞ÈÅìÂÖ∑
            powerups.forEach((powerup, powerupIndex) => {
                powerup.y += powerup.speed;
                powerup.bobOffset += 0.1; // ÊµÆÂä®Âä®Áîª
                
                // Ê£ÄÊü•‰∏éÁé©ÂÆ∂ÁöÑÁ¢∞Êíû
                if (powerup.x < player.x + player.width &&
                    powerup.x + powerup.width > player.x &&
                    powerup.y < player.y + player.height &&
                    powerup.y + powerup.height > player.y) {
                    
                    // Ëß¶ÂèëÊï∞Â≠¶È¢ò
                    showMathQuestion(powerup.type);
                    powerups.splice(powerupIndex, 1);
                }
            });
            
            // ÁßªÈô§Á¶ªÂºÄÂ±èÂπïÁöÑÈÅìÂÖ∑
            for (let i = powerups.length - 1; i >= 0; i--) {
                if (powerups[i].y > canvas.height) {
                    powerups.splice(i, 1);
                }
            }
            
            // Êõ¥Êñ∞UI
            document.getElementById('lives').textContent = game.lives;
            document.getElementById('score').textContent = game.score;
            document.getElementById('shield').textContent = game.shield;
            document.getElementById('missiles').textContent = game.missiles;
            document.getElementById('weaponLevel').textContent = game.weaponLevel;
            document.getElementById('gradeLevel').textContent = game.gradeLevel;
        }

        // ÁªòÂà∂Ê∏∏Êàè
        function draw() {
            // Âè™Âú®Ê∏∏ÊàèËøõË°åÊó∂ÁªòÂà∂Ê∏∏ÊàèÂÜÖÂÆπ
            if (game.state !== GAME_STATES.PLAYING) {
                // Ê∏ÖÁ©∫ÁîªÂ∏É
                ctx.fillStyle = '#111';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ÁªòÂà∂ÊòüÁ©∫ËÉåÊôØ
            for (let i = 0; i < 50; i++) {
                const x = (i * 73) % canvas.width;
                const y = ((Date.now() / 50 + i * 137) % canvas.height);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(x, y, 1, 1);
            }
            
            // ÁªòÂà∂Áé©ÂÆ∂ÔºàÊó†ÊïåÊó∂Èó™ÁÉÅÔºâ
            const playerAlpha = game.invulnerable > 0 && Math.floor(game.invulnerable / 5) % 2 ? 0.5 : 1;
            ctx.globalAlpha = playerAlpha;
            ctx.fillStyle = '#00ff00';
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1;
            
            // ÁªòÂà∂Êä§Áõæ
            if (game.shield > 0) {
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 30, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ÁªòÂà∂Êó†ÊïåÁä∂ÊÄÅÊåáÁ§∫
            if (game.invulnerable > 0) {
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.6)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 35, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ÁªòÂà∂Áé©ÂÆ∂Â≠êÂºπ
            ctx.fillStyle = '#ffff00';
            player.bullets.forEach(bullet => {
                ctx.fillRect(bullet.x - bullet.width / 2, bullet.y, bullet.width, bullet.height);
            });
            
            // ÁªòÂà∂ÊïåÊú∫
            ctx.fillStyle = '#ff0000';
            enemies.forEach(enemy => {
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });
            
            // ÁªòÂà∂ÊïåÊú∫Â≠êÂºπ
            ctx.fillStyle = '#ff00ff';
            enemyBullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.width, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // ÁªòÂà∂ÂØºÂºπ
            missiles.forEach(missile => {
                // ÁªòÂà∂ÂØºÂºπÂ∞æËøπ
                missile.trail.forEach(point => {
                    ctx.fillStyle = `rgba(255, 100, 0, ${point.alpha})`;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // ÁªòÂà∂ÂØºÂºπÊú¨‰Ωì
                ctx.fillStyle = '#0f0';
                ctx.save();
                ctx.translate(missile.x, missile.y);
                
                // ËÆ°ÁÆóÂØºÂºπÊúùÂêë
                if (missile.target && enemies.includes(missile.target)) {
                    const dx = missile.target.x + missile.target.width / 2 - missile.x;
                    const dy = missile.target.y + missile.target.height / 2 - missile.y;
                    const angle = Math.atan2(dy, dx) + Math.PI / 2;
                    ctx.rotate(angle);
                }
                
                // ÁªòÂà∂ÂØºÂºπÂΩ¢Áä∂
                ctx.beginPath();
                ctx.moveTo(0, -missile.height / 2);
                ctx.lineTo(-missile.width / 2, missile.height / 2);
                ctx.lineTo(0, missile.height / 3);
                ctx.lineTo(missile.width / 2, missile.height / 2);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            });
            
            // ÁªòÂà∂ÁàÜÁÇ∏ÊïàÊûú
            explosions.forEach(explosion => {
                ctx.fillStyle = `rgba(255, 100, 0, ${explosion.alpha})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // ÁªòÂà∂ÈÅìÂÖ∑
            powerups.forEach(powerup => {
                // ÊµÆÂä®ÊïàÊûú
                const bobY = powerup.y + Math.sin(powerup.bobOffset) * 3;
                
                // ÁªòÂà∂ÂèëÂÖâÊïàÊûú
                const gradient = ctx.createRadialGradient(
                    powerup.x + powerup.width / 2, bobY + powerup.height / 2, 0,
                    powerup.x + powerup.width / 2, bobY + powerup.height / 2, powerup.glowRadius
                );
                gradient.addColorStop(0, powerup.color + '80');
                gradient.addColorStop(1, powerup.color + '00');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(powerup.x + powerup.width / 2, bobY + powerup.height / 2, powerup.glowRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // ÁªòÂà∂ÈÅìÂÖ∑Êú¨‰Ωì
                ctx.fillStyle = powerup.color;
                ctx.fillRect(powerup.x, bobY, powerup.width, powerup.height);
                
                // ÁªòÂà∂ËæπÊ°Ü
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(powerup.x, bobY, powerup.width, powerup.height);
                
                // ÁªòÂà∂ÂõæÊ†á
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(
                    powerup.icon, 
                    powerup.x + powerup.width / 2, 
                    bobY + powerup.height / 2
                );
            });
        }

        // Ê∏∏ÊàèÂæ™ÁéØ
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ÈîÆÁõò‰∫ã‰ª∂
        document.addEventListener('keydown', (e) => {
            if (game.state !== GAME_STATES.PLAYING) return;
            
            keys[e.key] = true;
            
            // PÈîÆÊöÇÂÅúÊ∏∏Êàè
            if (e.key === 'p' || e.key === 'P') {
                togglePause();
            }
            
            // Êï∞Â≠óÈîÆÂàáÊç¢ÈöæÂ∫¶
            if (e.key >= '1' && e.key <= '3' && !game.paused) {
                game.gradeLevel = parseInt(e.key);
            }
        });

        document.addEventListener('keyup', (e) => {
            if (game.state !== GAME_STATES.PLAYING) return;
            keys[e.key] = false;
        });

        // ÂêØÂä®È°µÈù¢‰∫ã‰ª∂Â§ÑÁêÜ
        document.getElementById('startGameButton').addEventListener('click', startGame);
        
        // ÈöæÂ∫¶ÈÄâÊã©ÊåâÈíÆ‰∫ã‰ª∂
        document.querySelectorAll('.difficulty-button').forEach(button => {
            button.addEventListener('click', function() {
                // ÁßªÈô§ÊâÄÊúâselectedÁ±ª
                document.querySelectorAll('.difficulty-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Ê∑ªÂä†selectedÁ±ªÂà∞ÂΩìÂâçÊåâÈíÆ
                this.classList.add('selected');
                // ËÆæÁΩÆÈöæÂ∫¶Á≠âÁ∫ß
                game.gradeLevel = parseInt(this.getAttribute('data-grade'));
            });
        });

        // ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('restartButton').addEventListener('click', restartGame);
        
        // ËøîÂõû‰∏ªËèúÂçïÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('backToMenuButton').addEventListener('click', returnToStart);

        // ÂêØÂä®Ê∏∏Êàè
        gameLoop();
    </script>
</body>
</html>
