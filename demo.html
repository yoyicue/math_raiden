<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£ç®—é›·ç”µæ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        #gameContainer {
            position: relative;
        }
        canvas {
            border: 2px solid #333;
            display: block;
        }
        #mathModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff6600;
            padding: 30px;
            border-radius: 10px;
            display: none;
            z-index: 100;
            min-width: 300px;
            text-align: center;
        }
        #mathModal h2 {
            color: #ff6600;
            margin-bottom: 20px;
            font-size: 24px;
        }
        #mathQuestion {
            color: #fff;
            font-size: 28px;
            margin-bottom: 20px;
        }
        #mathAnswer {
            padding: 10px;
            font-size: 20px;
            width: 100px;
            text-align: center;
            background: #222;
            color: #fff;
            border: 2px solid #ff6600;
            border-radius: 5px;
        }
        #submitAnswer {
            padding: 10px 20px;
            font-size: 18px;
            background: #ff6600;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        #submitAnswer:hover {
            background: #ff8800;
        }
        #mathModal p {
            color: #aaa;
            font-size: 14px;
            margin-top: 15px;
            margin-bottom: 0;
        }
        #gameInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 18px;
            z-index: 10;
            display: none; /* é»˜è®¤éšè— */
        }
        #powerupInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #00ff00;
            font-size: 16px;
            z-index: 10;
            text-align: right;
            display: none; /* é»˜è®¤éšè— */
        }
        #pauseOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 90;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #pauseOverlay h2 {
            color: #00ff00;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        #pauseOverlay p {
            color: #fff;
            font-size: 20px;
        }
        .damage-hint {
            color: #ff6600;
            font-size: 14px;
            margin-top: 10px;
        }
        #gameOverOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #gameOverOverlay h1 {
            color: #ff4444;
            font-size: 64px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff4444;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 20px #ff4444; }
            to { text-shadow: 0 0 30px #ff4444, 0 0 40px #ff6666; }
        }
        #gameOverOverlay .final-score {
            color: #00ff00;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        #gameOverOverlay .game-stats {
            color: #fff;
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.5;
        }
        #gameOverOverlay .game-stats div {
            margin: 5px 0;
        }
        #restartButton {
            padding: 15px 30px;
            font-size: 24px;
            background: linear-gradient(45deg, #ff6600, #ff8800);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
            transition: all 0.3s ease;
        }
        #restartButton:hover {
            background: linear-gradient(45deg, #ff8800, #ffaa00);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }
        #backToMenuButton {
            padding: 10px 20px;
            font-size: 18px;
            background: transparent;
            color: #888;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        #backToMenuButton:hover {
            color: #fff;
            border-color: #777;
        }
        .achievement {
            color: #ffd700;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px #ffd700;
        }
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            display: flex;
            z-index: 300;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: backgroundFlow 10s ease-in-out infinite alternate;
        }
        @keyframes backgroundFlow {
            0% { background: linear-gradient(135deg, #000428 0%, #004e92 100%); }
            50% { background: linear-gradient(135deg, #004e92 0%, #009ffd 100%); }
            100% { background: linear-gradient(135deg, #000428 0%, #004e92 100%); }
        }
        #startScreen h1 {
            color: #00ff00;
            font-size: 72px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
            animation: titleGlow 3s ease-in-out infinite alternate;
            font-family: 'Arial Black', Arial, sans-serif;
            letter-spacing: 3px;
        }
        @keyframes titleGlow {
            from { 
                text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px #00ff00, 0 0 80px #00ff00, 0 0 120px #00ff00;
                transform: scale(1.05);
            }
        }
        #startScreen .subtitle {
            color: #fff;
            font-size: 24px;
            margin-bottom: 40px;
            text-align: center;
            opacity: 0.9;
        }
        #startScreen .game-features {
            color: #aaa;
            font-size: 16px;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.6;
        }
        #startScreen .game-features div {
            margin: 8px 0;
        }
        .start-button {
            padding: 20px 40px;
            font-size: 28px;
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 15px;
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .start-button:hover {
            background: linear-gradient(45deg, #00cc00, #00aa00);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.4);
        }
        .difficulty-selector {
            margin: 30px 0;
            text-align: center;
        }
        .difficulty-selector h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .difficulty-button {
            padding: 10px 20px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .difficulty-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #777;
        }
        .difficulty-button.selected {
            background: linear-gradient(45deg, #ff6600, #ff8800);
            border-color: #ff6600;
            color: #fff;
        }
        .controls-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #888;
            font-size: 14px;
            text-align: center;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="startScreen">
            <h1>å£ç®—é›·ç”µ</h1>
            <div class="subtitle">è¾¹ç©è¾¹å­¦ï¼Œæå‡æ•°å­¦æŠ€èƒ½çš„å°„å‡»æ¸¸æˆ</div>
            <div class="game-features">
                <div>ğŸš€ æ¿€çƒˆçš„å°„å‡»æˆ˜æ–—ä½“éªŒ</div>
                <div>ğŸ§® é€šè¿‡è§£é¢˜è·å¾—å¼ºåŠ›é“å…·</div>
                <div>âš¡ å¤šç§æ­¦å™¨å’ŒæŠ€èƒ½ç³»ç»Ÿ</div>
                <div>ğŸ¯ ä¸»åŠ¨é€‰æ‹©åšé¢˜æ—¶æœº</div>
            </div>
            <div class="difficulty-selector">
                <h3>é€‰æ‹©æ•°å­¦éš¾åº¦</h3>
                <button class="difficulty-button selected" data-grade="1">G1 - 10ä»¥å†…åŠ å‡æ³•</button>
                <button class="difficulty-button" data-grade="2">G2 - 20ä»¥å†…åŠ å‡æ³•</button>
                <button class="difficulty-button" data-grade="3">G3 - ä¹˜æ³•è¿ç®—</button>
            </div>
            <button class="start-button" id="startGameButton">å¼€å§‹æ¸¸æˆ</button>
            <div class="controls-info">
                <div><strong>æ“ä½œè¯´æ˜ï¼š</strong></div>
                <div>æ–¹å‘é”®ç§»åŠ¨ | è‡ªåŠ¨å°„å‡» | Pé”®æš‚åœ | åƒé“å…·åšé¢˜è·å¾—å¥–åŠ±</div>
            </div>
        </div>
        <canvas id="gameCanvas" width="600" height="800"></canvas>
        <div id="gameInfo">
            <div>ç”Ÿå‘½å€¼: <span id="lives">3</span></div>
            <div>åˆ†æ•°: <span id="score">0</span></div>
            <div>æŠ¤ç›¾: <span id="shield">0</span></div>
            <div>å¯¼å¼¹: <span id="missiles">0</span></div>
            <div style="margin-top: 10px; font-size: 14px; color: #888;">æŒ‰ P æš‚åœ</div>
        </div>
        <div id="powerupInfo">
            <div>æ­¦å™¨ç­‰çº§: <span id="weaponLevel">1</span></div>
            <div>éš¾åº¦: G<span id="gradeLevel">1</span></div>
        </div>
        <div id="pauseOverlay">
            <h2>æ¸¸æˆæš‚åœ</h2>
            <p>æŒ‰ P é”®ç»§ç»­æ¸¸æˆ</p>
        </div>
        <div id="mathModal">
            <h2>é“å…·æ¿€æ´»ï¼</h2>
            <div class="damage-hint">è§£ç­”æ•°å­¦é¢˜è·å¾—é“å…·å¥–åŠ±</div>
            <div id="mathQuestion"></div>
            <input type="number" id="mathAnswer" autofocus>
            <button id="submitAnswer">ç¡®å®š</button>
            <p style="color: #888; font-size: 14px; margin-top: 10px;">ç­”å¯¹è·å¾—å¼ºåŒ–å¥–åŠ±ï¼Œç­”é”™è·å¾—åŸºç¡€å¥–åŠ±</p>
        </div>
        <div id="gameOverOverlay">
            <h1>GAME OVER</h1>
            <div class="final-score">æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></div>
            <div class="game-stats">
                <div>å‡»è´¥æ•Œæœº: <span id="finalEnemies">0</span> æ¶</div>
                <div>å­˜æ´»æ—¶é—´: <span id="survivalTime">0</span> ç§’</div>
                <div>æœ€é«˜æ­¦å™¨ç­‰çº§: <span id="maxWeaponLevel">1</span></div>
                <div>æ•°å­¦é¢˜éš¾åº¦: G<span id="finalGrade">1</span></div>
                <div id="achievementText" class="achievement" style="display: none;"></div>
            </div>
            <button id="restartButton">é‡æ–°å¼€å§‹</button>
            <button id="backToMenuButton">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆçŠ¶æ€
        const GAME_STATES = {
            START: 'start',
            PLAYING: 'playing',
            GAME_OVER: 'gameOver'
        };

        const game = {
            state: GAME_STATES.START,
            paused: false,
            manualPaused: false,  // æ‰‹åŠ¨æš‚åœçŠ¶æ€
            score: 0,
            lives: 3,
            shield: 0,
            weaponLevel: 1,
            gradeLevel: 1,
            enemiesDefeated: 0,
            missiles: 0,  // å¯¼å¼¹æ•°é‡
            invulnerable: 0,  // æ— æ•Œæ—¶é—´ï¼ˆå¸§æ•°ï¼‰
            startTime: Date.now(),
            maxWeaponLevel: 1
        };

        // ç©å®¶é£æœº
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 40,
            height: 40,
            speed: 5,
            bullets: []
        };

        // æ•Œæœºæ•°ç»„
        const enemies = [];
        const enemyBullets = [];
        const explosions = [];
        const missiles = [];  // å¯¼å¼¹æ•°ç»„
        const powerups = [];  // é“å…·æ•°ç»„

        // é”®ç›˜çŠ¶æ€
        const keys = {};

        // æ•°å­¦é¢˜ç³»ç»Ÿ
        class MathQuestion {
            constructor(grade) {
                this.grade = grade;
                this.generateQuestion();
            }

            generateQuestion() {
                switch(this.grade) {
                    case 1: // G1: 10ä»¥å†…åŠ å‡æ³•
                        const a = Math.floor(Math.random() * 10) + 1;
                        const b = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) {
                            this.question = `${a} + ${b} = ?`;
                            this.answer = a + b;
                        } else {
                            const max = Math.max(a, b);
                            const min = Math.min(a, b);
                            this.question = `${max} - ${min} = ?`;
                            this.answer = max - min;
                        }
                        break;
                    case 2: // G2: 20ä»¥å†…åŠ å‡æ³•
                        const c = Math.floor(Math.random() * 20) + 1;
                        const d = Math.floor(Math.random() * 20) + 1;
                        if (Math.random() < 0.5) {
                            this.question = `${c} + ${d} = ?`;
                            this.answer = c + d;
                        } else {
                            const max2 = Math.max(c, d);
                            const min2 = Math.min(c, d);
                            this.question = `${max2} - ${min2} = ?`;
                            this.answer = max2 - min2;
                        }
                        break;
                    case 3: // G3: ä¹˜æ³•
                        const e = Math.floor(Math.random() * 10) + 1;
                        const f = Math.floor(Math.random() * 10) + 1;
                        this.question = `${e} Ã— ${f} = ?`;
                        this.answer = e * f;
                        break;
                    default:
                        this.generateQuestion.call({grade: 1});
                }
            }
        }

        // é“å…·ç±»å‹
        const POWERUP_TYPES = {
            WEAPON: { color: '#ffff00', name: 'æ­¦å™¨å‡çº§', icon: 'âš¡' },
            SHIELD: { color: '#00ffff', name: 'æŠ¤ç›¾', icon: 'ğŸ›¡ï¸' },
            LIFE: { color: '#ff00ff', name: 'ç”Ÿå‘½å€¼', icon: 'â¤ï¸' },
            BOMB: { color: '#ff4444', name: 'æ¸…å±ç‚¸å¼¹', icon: 'ğŸ’¥' },
            MISSILE: { color: '#00ff00', name: 'è¿½è¸ªå¯¼å¼¹', icon: 'ğŸš€' },
            SCORE: { color: '#ffd700', name: 'åˆ†æ•°å¥–åŠ±', icon: 'â­' }
        };

        // åˆ›å»ºæ•Œæœº
        function createEnemy() {
            enemies.push({
                x: Math.random() * (canvas.width - 40),
                y: -40,
                width: 40,
                height: 40,
                speed: 2 + Math.random() * 2,
                hp: 1,
                shootTimer: 0
            });
        }

        // åˆ›å»ºå­å¼¹
        function createBullet(x, y, angle = 0, isPlayer = true) {
            const bullet = {
                x: x,
                y: y,
                width: 4,
                height: 10,
                speed: isPlayer ? 10 : 5,
                angle: angle,
                isPlayer: isPlayer
            };
            
            if (isPlayer) {
                player.bullets.push(bullet);
            } else {
                enemyBullets.push(bullet);
            }
        }

        // åˆ›å»ºé“å…·
        function createPowerup(x, y, type) {
            const powerupType = POWERUP_TYPES[type];
            powerups.push({
                x: x,
                y: y,
                width: 35,
                height: 35,
                type: type,
                speed: 1.5,
                color: powerupType.color,
                name: powerupType.name,
                icon: powerupType.icon,
                bobOffset: Math.random() * Math.PI * 2, // æµ®åŠ¨åŠ¨ç”»åç§»
                glowRadius: 20
            });
        }

        // éšæœºæ‰è½é“å…·
        function dropRandomPowerup(x, y) {
            // 30% æ¦‚ç‡æ‰è½é“å…·
            if (Math.random() < 0.3) {
                const types = Object.keys(POWERUP_TYPES);
                const randomType = types[Math.floor(Math.random() * types.length)];
                createPowerup(x, y, randomType);
            }
        }

        // åˆ›å»ºå¯¼å¼¹
        function createMissile(x, y) {
            if (enemies.length === 0) return;
            
            // æ‰¾åˆ°æœ€è¿‘çš„æ•Œäºº
            let nearestEnemy = enemies[0];
            let minDistance = Infinity;
            
            enemies.forEach(enemy => {
                const distance = Math.sqrt(Math.pow(enemy.x - x, 2) + Math.pow(enemy.y - y, 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestEnemy = enemy;
                }
            });
            
            missiles.push({
                x: x,
                y: y,
                width: 8,
                height: 16,
                speed: 8,
                target: nearestEnemy,
                trail: []  // å¯¼å¼¹å°¾è¿¹
            });
        }

        // åˆ‡æ¢æš‚åœçŠ¶æ€
        function togglePause() {
            if (!game.paused) {
                // æš‚åœæ¸¸æˆ
                game.paused = true;
                game.manualPaused = true;
                document.getElementById('pauseOverlay').style.display = 'flex';
            } else if (game.manualPaused && !document.getElementById('mathModal').style.display.includes('block')) {
                // ç»§ç»­æ¸¸æˆï¼ˆä»…å½“ä¸æ˜¯æ•°å­¦é¢˜æš‚åœæ—¶ï¼‰
                game.paused = false;
                game.manualPaused = false;
                document.getElementById('pauseOverlay').style.display = 'none';
            }
        }

        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(x, y) {
            explosions.push({
                x: x,
                y: y,
                radius: 5,
                maxRadius: 30,
                alpha: 1
            });
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸç”»é¢
        function showGameOver() {
            game.state = GAME_STATES.GAME_OVER;
            game.paused = true;
            
            // è®¡ç®—ç”Ÿå­˜æ—¶é—´
            const survivalTime = Math.floor((Date.now() - game.startTime) / 1000);
            
            // æ£€æµ‹æˆå°±
            let achievement = '';
            if (game.score >= 5000) achievement = 'ğŸ† ä¼ å¥‡é£è¡Œå‘˜ï¼';
            else if (game.score >= 2000) achievement = 'â­ ç‹ç‰Œé£è¡Œå‘˜ï¼';
            else if (game.score >= 1000) achievement = 'ğŸ–ï¸ ç²¾è‹±é£è¡Œå‘˜ï¼';
            else if (game.enemiesDefeated >= 50) achievement = 'ğŸ’¥ æ•Œæœºæ€æ‰‹ï¼';
            else if (survivalTime >= 300) achievement = 'â° é•¿ä¹…ç”Ÿå­˜è€…ï¼';
            else if (game.maxWeaponLevel >= 3) achievement = 'ğŸ”« æ­¦å™¨å¤§å¸ˆï¼';
            else if (game.gradeLevel >= 3) achievement = 'ğŸ§® æ•°å­¦å¤©æ‰ï¼';
            
            // æ›´æ–°æ¸¸æˆç»“æŸç”»é¢çš„æ•°æ®
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('finalEnemies').textContent = game.enemiesDefeated;
            document.getElementById('survivalTime').textContent = survivalTime;
            document.getElementById('maxWeaponLevel').textContent = game.maxWeaponLevel;
            document.getElementById('finalGrade').textContent = game.gradeLevel;
            
            // æ˜¾ç¤ºæˆå°±
            if (achievement) {
                document.getElementById('achievementText').textContent = achievement;
                document.getElementById('achievementText').style.display = 'block';
            } else {
                document.getElementById('achievementText').style.display = 'none';
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç”»é¢
            document.getElementById('gameOverOverlay').style.display = 'flex';
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            game.state = GAME_STATES.PLAYING;
            game.paused = false;
            game.manualPaused = false;
            game.score = 0;
            game.lives = 3;
            game.shield = 0;
            game.weaponLevel = 1;
            game.enemiesDefeated = 0;
            game.missiles = 0;
            game.invulnerable = 0;
            game.startTime = Date.now();
            game.maxWeaponLevel = 1;
            
            // é‡ç½®ç©å®¶ä½ç½®
            player.x = canvas.width / 2;
            player.y = canvas.height - 100;
            
            // æ¸…ç©ºæ‰€æœ‰æ•°ç»„
            player.bullets.length = 0;
            enemies.length = 0;
            enemyBullets.length = 0;
            explosions.length = 0;
            missiles.length = 0;
            powerups.length = 0;
            
            // éšè—å¯åŠ¨é¡µé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆUI
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'block';
            document.getElementById('powerupInfo').style.display = 'block';
        }

        // è¿”å›å¯åŠ¨é¡µé¢
        function returnToStart() {
            game.state = GAME_STATES.START;
            game.paused = false;
            game.manualPaused = false;
            
            // æ¸…ç©ºæ‰€æœ‰æ•°ç»„
            player.bullets.length = 0;
            enemies.length = 0;
            enemyBullets.length = 0;
            explosions.length = 0;
            missiles.length = 0;
            powerups.length = 0;
            
            // æ˜¾ç¤ºå¯åŠ¨é¡µé¢ï¼Œéšè—æ¸¸æˆUI
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('gameOverOverlay').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('powerupInfo').style.display = 'none';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            startGame();
        }

        // ç©å®¶å—ä¼¤å¤„ç†
        function playerTakeDamage() {
            if (game.invulnerable > 0) return; // æ— æ•ŒçŠ¶æ€ä¸­ä¸å—ä¼¤
            
            if (game.shield > 0) {
                game.shield--;
                game.invulnerable = 60; // 1ç§’æ— æ•Œæ—¶é—´
            } else {
                game.lives--;
                game.invulnerable = 120; // 2ç§’æ— æ•Œæ—¶é—´
                if (game.lives <= 0) {
                    showGameOver();
                    return;
                }
            }
        }

        // æ˜¾ç¤ºæ•°å­¦é¢˜
        function showMathQuestion() {
            game.paused = true;
            const question = new MathQuestion(game.gradeLevel);
            
            document.getElementById('mathQuestion').textContent = question.question;
            document.getElementById('mathAnswer').value = '';
            document.getElementById('mathModal').style.display = 'block';
            
            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('mathAnswer').focus();
            }, 100);
            
            // å¤„ç†ç­”æ¡ˆæäº¤
            const submitHandler = () => {
                const userAnswer = parseInt(document.getElementById('mathAnswer').value);
                let rewardMessage = '';
                
                if (userAnswer === question.answer) {
                    // ç­”å¯¹äº†ï¼Œè·å¾—æ•‘æ´å¥–åŠ±
                    const types = Object.keys(POWERUP_TYPES);
                    const randomType = types[Math.floor(Math.random() * types.length)];
                    
                    // ç›´æ¥åº”ç”¨é“å…·æ•ˆæœ
                    switch(randomType) {
                        case 'WEAPON':
                            if (game.weaponLevel < 3) {
                                game.weaponLevel++;
                                game.maxWeaponLevel = Math.max(game.maxWeaponLevel, game.weaponLevel);
                                rewardMessage = 'æ­¦å™¨å‡çº§ï¼é£æœºä¿®å¤å®Œæˆï¼';
                            } else {
                                rewardMessage = 'æ­¦å™¨å·²æ»¡çº§ï¼è·å¾—200åˆ†ä¿®å¤å¥–åŠ±ï¼';
                                game.score += 200;
                            }
                            break;
                        case 'SHIELD':
                            game.shield = Math.min(game.shield + 15, 25);
                            rewardMessage = 'æŠ¤ç›¾å¼ºåŒ–ï¼è·å¾—æŠ¤ç›¾+15ï¼';
                            break;
                        case 'LIFE':
                            game.lives = Math.min(game.lives + 1, 5);
                            rewardMessage = 'ç”Ÿå‘½å€¼æ¢å¤ï¼+1ç”Ÿå‘½ï¼';
                            break;
                        case 'BOMB':
                            // æ¸…å±ç‚¸å¼¹æ•ˆæœ
                            enemies.forEach(enemy => {
                                createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                                game.score += 10;
                            });
                            enemies.length = 0;
                            enemyBullets.length = 0;
                            rewardMessage = 'ç´§æ€¥æ¸…å±ï¼æ‰€æœ‰æ•Œæœºè¢«æ¶ˆç­ï¼';
                            break;
                        case 'MISSILE':
                            game.missiles = Math.min(game.missiles + 50, 100);
                            rewardMessage = 'å¯¼å¼¹è¡¥ç»™ï¼è·å¾—è¿½è¸ªå¯¼å¼¹+50ï¼';
                            break;
                    }
                    
                    game.score += 100; // æ•‘æ´æˆåŠŸé¢å¤–åŠ åˆ†
                    game.invulnerable = 180; // 3ç§’æ— æ•Œæ—¶é—´
                } else {
                    // ç­”é”™äº†ï¼Œç»™äºˆå®‰æ…°å¥–åŠ±
                    rewardMessage = 'ä¿®å¤æœªå®Œæˆï¼Œä½†è·å¾—1ç§’ä¿æŠ¤æ—¶é—´';
                    game.invulnerable = 60; // 1ç§’ä¿æŠ¤æ—¶é—´
                }
                
                // å…ˆå…³é—­å¯¹è¯æ¡†
                document.getElementById('mathModal').style.display = 'none';
                game.paused = false;
                game.manualPaused = false;
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('submitAnswer').removeEventListener('click', submitHandler);
                document.getElementById('mathAnswer').removeEventListener('keypress', enterHandler);
                document.getElementById('mathAnswer').removeEventListener('input', inputHandler);
                
                // å»¶è¿Ÿæ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯
                if (rewardMessage) {
                    setTimeout(() => {
                        const rewardDiv = document.createElement('div');
                        const isSuccess = userAnswer === question.answer;
                        const borderColor = isSuccess ? '#00ff00' : '#ff6600';
                        const textColor = isSuccess ? '#00ff00' : '#ff6600';
                        
                        rewardDiv.style.cssText = `position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: ${textColor}; font-size: 24px; font-weight: bold; z-index: 200; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 10px; border: 2px solid ${borderColor};`;
                        rewardDiv.textContent = rewardMessage;
                        document.getElementById('gameContainer').appendChild(rewardDiv);
                        
                        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                        setTimeout(() => {
                            rewardDiv.style.transition = 'opacity 0.5s';
                            rewardDiv.style.opacity = '0';
                            setTimeout(() => rewardDiv.remove(), 500);
                        }, 2000);
                    }, 100);
                }
            };
            
            const enterHandler = (e) => {
                if (e.key === 'Enter' && document.getElementById('mathAnswer').value !== '') {
                    submitHandler();
                }
            };
            
            // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨æäº¤
            const inputHandler = (e) => {
                const userAnswer = parseInt(e.target.value);
                // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦å¯èƒ½æ­£ç¡®ï¼ˆé¿å…è¾“å…¥è¿‡ç¨‹ä¸­è¯¯åˆ¤ï¼‰
                if (!isNaN(userAnswer) && e.target.value.length >= question.answer.toString().length) {
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œè®©ç”¨æˆ·çœ‹æ¸…è‡ªå·±è¾“å…¥çš„å†…å®¹
                    setTimeout(() => {
                        if (document.getElementById('mathAnswer').value === e.target.value) {
                            submitHandler();
                        }
                    }, 300);
                }
            };
            
            document.getElementById('submitAnswer').addEventListener('click', submitHandler);
            document.getElementById('mathAnswer').addEventListener('keypress', enterHandler);
            document.getElementById('mathAnswer').addEventListener('input', inputHandler);
        }

        // æ›´æ–°æ¸¸æˆ
        function update() {
            if (game.state !== GAME_STATES.PLAYING || game.paused) return;
            
            // æ›´æ–°æ— æ•Œæ—¶é—´
            if (game.invulnerable > 0) {
                game.invulnerable--;
            }
            
            // æ›´æ–°ç©å®¶ä½ç½®
            if (keys['ArrowLeft'] && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            if (keys['ArrowUp'] && player.y > 0) {
                player.y -= player.speed;
            }
            if (keys['ArrowDown'] && player.y < canvas.height - player.height) {
                player.y += player.speed;
            }
            
            // è‡ªåŠ¨å‘å°„å­å¼¹
            if (!player.lastShot || Date.now() - player.lastShot > 200) {
                if (game.weaponLevel === 1) {
                    createBullet(player.x + player.width / 2, player.y);
                } else if (game.weaponLevel === 2) {
                    createBullet(player.x + 10, player.y);
                    createBullet(player.x + player.width - 10, player.y);
                } else if (game.weaponLevel >= 3) {
                    createBullet(player.x + player.width / 2, player.y);
                    createBullet(player.x + 5, player.y, -0.2);
                    createBullet(player.x + player.width - 5, player.y, 0.2);
                }
                player.lastShot = Date.now();
            }
            
            // è‡ªåŠ¨å‘å°„å¯¼å¼¹
            if (game.missiles > 0 && (!player.lastMissile || Date.now() - player.lastMissile > 1000)) {
                createMissile(player.x + player.width / 2, player.y);
                game.missiles--;
                player.lastMissile = Date.now();
            }
            
            // æ›´æ–°ç©å®¶å­å¼¹
            player.bullets = player.bullets.filter(bullet => {
                bullet.y -= bullet.speed;
                bullet.x += Math.sin(bullet.angle) * bullet.speed;
                return bullet.y > -10 && bullet.x > -10 && bullet.x < canvas.width + 10;
            });
            
            // æ›´æ–°æ•Œæœº
            enemies.forEach((enemy, enemyIndex) => {
                enemy.y += enemy.speed;
                
                // æ•Œæœºå°„å‡»
                enemy.shootTimer++;
                if (enemy.shootTimer > 60) {
                    createBullet(enemy.x + enemy.width / 2, enemy.y + enemy.height, 0, false);
                    enemy.shootTimer = 0;
                }
                
                // æ£€æŸ¥ä¸ç©å®¶å­å¼¹çš„ç¢°æ’
                player.bullets.forEach((bullet, bulletIndex) => {
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        enemy.hp--;
                        player.bullets.splice(bulletIndex, 1);
                        
                        if (enemy.hp <= 0) {
                            createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                            
                            // æ‰è½é“å…·
                            dropRandomPowerup(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                            
                            enemies.splice(enemyIndex, 1);
                            game.score += 10;
                            game.enemiesDefeated++;
                        }
                    }
                });
            });
            
            // ç§»é™¤ç¦»å¼€å±å¹•çš„æ•Œæœº
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (enemies[i].y > canvas.height) {
                    enemies.splice(i, 1);
                }
            }
            
            // æ›´æ–°æ•Œæœºå­å¼¹
            enemyBullets.forEach((bullet, index) => {
                bullet.y += bullet.speed;
                
                // æ£€æŸ¥ä¸ç©å®¶çš„ç¢°æ’
                if (bullet.x < player.x + player.width &&
                    bullet.x + bullet.width > player.x &&
                    bullet.y < player.y + player.height &&
                    bullet.y + bullet.height > player.y) {
                    
                    enemyBullets.splice(index, 1);
                    playerTakeDamage(); // è°ƒç”¨å—ä¼¤å¤„ç†å‡½æ•°
                }
            });
            
            // ç§»é™¤ç¦»å¼€å±å¹•çš„æ•Œæœºå­å¼¹
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                if (enemyBullets[i].y > canvas.height) {
                    enemyBullets.splice(i, 1);
                }
            }
            
            // æ›´æ–°å¯¼å¼¹
            missiles.forEach((missile, missileIndex) => {
                // æ·»åŠ å°¾è¿¹
                missile.trail.push({ x: missile.x, y: missile.y, alpha: 1 });
                if (missile.trail.length > 10) {
                    missile.trail.shift();
                }
                
                // æ›´æ–°å°¾è¿¹é€æ˜åº¦
                missile.trail.forEach((point, i) => {
                    point.alpha = (i + 1) / missile.trail.length * 0.5;
                });
                
                // å¦‚æœç›®æ ‡è¿˜å­˜åœ¨ï¼Œè¿½è¸ªç›®æ ‡
                if (missile.target && enemies.includes(missile.target)) {
                    const dx = missile.target.x + missile.target.width / 2 - missile.x;
                    const dy = missile.target.y + missile.target.height / 2 - missile.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        missile.x += (dx / distance) * missile.speed;
                        missile.y += (dy / distance) * missile.speed;
                    }
                    
                    // æ£€æŸ¥ç¢°æ’
                    if (distance < 20) {
                        createExplosion(missile.target.x + missile.target.width / 2, 
                                      missile.target.y + missile.target.height / 2);
                        
                        // æ‰è½é“å…·
                        dropRandomPowerup(missile.target.x + missile.target.width / 2, 
                                        missile.target.y + missile.target.height / 2);
                        
                        const enemyIndex = enemies.indexOf(missile.target);
                        if (enemyIndex > -1) {
                            enemies.splice(enemyIndex, 1);
                            game.score += 15;  // å¯¼å¼¹å‡»ä¸­é¢å¤–åŠ åˆ†
                        }
                        missiles.splice(missileIndex, 1);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œå‘ä¸Šé£è¡Œ
                    missile.y -= missile.speed;
                    
                    // ç¦»å¼€å±å¹•åç§»é™¤
                    if (missile.y < -20) {
                        missiles.splice(missileIndex, 1);
                    }
                }
            });
            
            // æ›´æ–°çˆ†ç‚¸æ•ˆæœ
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.radius += 2;
                explosion.alpha -= 0.05;
                
                if (explosion.alpha <= 0) {
                    explosions.splice(i, 1);
                }
            }
            
            // ç”Ÿæˆæ–°æ•Œæœº
            if (Math.random() < 0.02) {
                createEnemy();
            }
            
            // æ›´æ–°é“å…·
            powerups.forEach((powerup, powerupIndex) => {
                powerup.y += powerup.speed;
                powerup.bobOffset += 0.1; // æµ®åŠ¨åŠ¨ç”»
                
                // æ£€æŸ¥ä¸ç©å®¶çš„ç¢°æ’
                if (powerup.x < player.x + player.width &&
                    powerup.x + powerup.width > player.x &&
                    powerup.y < player.y + player.height &&
                    powerup.y + powerup.height > player.y) {
                    
                    // è§¦å‘æ•°å­¦é¢˜
                    showMathQuestion(powerup.type);
                    powerups.splice(powerupIndex, 1);
                }
            });
            
            // ç§»é™¤ç¦»å¼€å±å¹•çš„é“å…·
            for (let i = powerups.length - 1; i >= 0; i--) {
                if (powerups[i].y > canvas.height) {
                    powerups.splice(i, 1);
                }
            }
            
            // æ›´æ–°UI
            document.getElementById('lives').textContent = game.lives;
            document.getElementById('score').textContent = game.score;
            document.getElementById('shield').textContent = game.shield;
            document.getElementById('missiles').textContent = game.missiles;
            document.getElementById('weaponLevel').textContent = game.weaponLevel;
            document.getElementById('gradeLevel').textContent = game.gradeLevel;
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // åªåœ¨æ¸¸æˆè¿›è¡Œæ—¶ç»˜åˆ¶æ¸¸æˆå†…å®¹
            if (game.state !== GAME_STATES.PLAYING) {
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#111';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ˜Ÿç©ºèƒŒæ™¯
            for (let i = 0; i < 50; i++) {
                const x = (i * 73) % canvas.width;
                const y = ((Date.now() / 50 + i * 137) % canvas.height);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(x, y, 1, 1);
            }
            
            // ç»˜åˆ¶ç©å®¶ï¼ˆæ— æ•Œæ—¶é—ªçƒï¼‰
            const playerAlpha = game.invulnerable > 0 && Math.floor(game.invulnerable / 5) % 2 ? 0.5 : 1;
            ctx.globalAlpha = playerAlpha;
            ctx.fillStyle = '#00ff00';
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1;
            
            // ç»˜åˆ¶æŠ¤ç›¾
            if (game.shield > 0) {
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 30, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æ— æ•ŒçŠ¶æ€æŒ‡ç¤º
            if (game.invulnerable > 0) {
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.6)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 35, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶ç©å®¶å­å¼¹
            ctx.fillStyle = '#ffff00';
            player.bullets.forEach(bullet => {
                ctx.fillRect(bullet.x - bullet.width / 2, bullet.y, bullet.width, bullet.height);
            });
            
            // ç»˜åˆ¶æ•Œæœº
            ctx.fillStyle = '#ff0000';
            enemies.forEach(enemy => {
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });
            
            // ç»˜åˆ¶æ•Œæœºå­å¼¹
            ctx.fillStyle = '#ff00ff';
            enemyBullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.width, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // ç»˜åˆ¶å¯¼å¼¹
            missiles.forEach(missile => {
                // ç»˜åˆ¶å¯¼å¼¹å°¾è¿¹
                missile.trail.forEach(point => {
                    ctx.fillStyle = `rgba(255, 100, 0, ${point.alpha})`;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // ç»˜åˆ¶å¯¼å¼¹æœ¬ä½“
                ctx.fillStyle = '#0f0';
                ctx.save();
                ctx.translate(missile.x, missile.y);
                
                // è®¡ç®—å¯¼å¼¹æœå‘
                if (missile.target && enemies.includes(missile.target)) {
                    const dx = missile.target.x + missile.target.width / 2 - missile.x;
                    const dy = missile.target.y + missile.target.height / 2 - missile.y;
                    const angle = Math.atan2(dy, dx) + Math.PI / 2;
                    ctx.rotate(angle);
                }
                
                // ç»˜åˆ¶å¯¼å¼¹å½¢çŠ¶
                ctx.beginPath();
                ctx.moveTo(0, -missile.height / 2);
                ctx.lineTo(-missile.width / 2, missile.height / 2);
                ctx.lineTo(0, missile.height / 3);
                ctx.lineTo(missile.width / 2, missile.height / 2);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            });
            
            // ç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ
            explosions.forEach(explosion => {
                ctx.fillStyle = `rgba(255, 100, 0, ${explosion.alpha})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // ç»˜åˆ¶é“å…·
            powerups.forEach(powerup => {
                // æµ®åŠ¨æ•ˆæœ
                const bobY = powerup.y + Math.sin(powerup.bobOffset) * 3;
                
                // ç»˜åˆ¶å‘å…‰æ•ˆæœ
                const gradient = ctx.createRadialGradient(
                    powerup.x + powerup.width / 2, bobY + powerup.height / 2, 0,
                    powerup.x + powerup.width / 2, bobY + powerup.height / 2, powerup.glowRadius
                );
                gradient.addColorStop(0, powerup.color + '80');
                gradient.addColorStop(1, powerup.color + '00');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(powerup.x + powerup.width / 2, bobY + powerup.height / 2, powerup.glowRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶é“å…·æœ¬ä½“
                ctx.fillStyle = powerup.color;
                ctx.fillRect(powerup.x, bobY, powerup.width, powerup.height);
                
                // ç»˜åˆ¶è¾¹æ¡†
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(powerup.x, bobY, powerup.width, powerup.height);
                
                // ç»˜åˆ¶å›¾æ ‡
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(
                    powerup.icon, 
                    powerup.x + powerup.width / 2, 
                    bobY + powerup.height / 2
                );
            });
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (game.state !== GAME_STATES.PLAYING) return;
            
            keys[e.key] = true;
            
            // Pé”®æš‚åœæ¸¸æˆ
            if (e.key === 'p' || e.key === 'P') {
                togglePause();
            }
            
            // æ•°å­—é”®åˆ‡æ¢éš¾åº¦
            if (e.key >= '1' && e.key <= '3' && !game.paused) {
                game.gradeLevel = parseInt(e.key);
            }
        });

        document.addEventListener('keyup', (e) => {
            if (game.state !== GAME_STATES.PLAYING) return;
            keys[e.key] = false;
        });

        // å¯åŠ¨é¡µé¢äº‹ä»¶å¤„ç†
        document.getElementById('startGameButton').addEventListener('click', startGame);
        
        // éš¾åº¦é€‰æ‹©æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.difficulty-button').forEach(button => {
            button.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰selectedç±»
                document.querySelectorAll('.difficulty-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // æ·»åŠ selectedç±»åˆ°å½“å‰æŒ‰é’®
                this.classList.add('selected');
                // è®¾ç½®éš¾åº¦ç­‰çº§
                game.gradeLevel = parseInt(this.getAttribute('data-grade'));
            });
        });

        // é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
        document.getElementById('restartButton').addEventListener('click', restartGame);
        
        // è¿”å›ä¸»èœå•æŒ‰é’®äº‹ä»¶
        document.getElementById('backToMenuButton').addEventListener('click', returnToStart);

        // å¯åŠ¨æ¸¸æˆ
        gameLoop();
    </script>
</body>
</html>
